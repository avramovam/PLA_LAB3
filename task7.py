"""
–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ3: –ú–∞—Ç—Ä–∏—Ü—ã –≤ 3D-–≥—Ä–∞—Ñ–∏–∫–µ
–ó–∞–¥–∞–Ω–∏–µ 7: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
"""

import numpy as np
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d.art3d import Poly3DCollection
import os

# –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
os.makedirs('img', exist_ok=True)

# ============================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ó–ê–î–ê–ù–ò–Ø 7 ==============================

def load_task6_data():
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∑–∞–¥–∞–Ω–∏—è 6
    """
    try:
        data = np.load('data/task6_data.npz', allow_pickle=True)
        cubes_vertices = data['cubes_vertices']
        cubes_colors = data['cubes_colors']
        faces = data['faces']
        C = data['C']
        C_inv = data['C_inv']

        cubes = [(cubes_vertices[i], cubes_colors[i]) for i in range(len(cubes_vertices))]
        return cubes, faces, C, C_inv
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è 6: {e}")
        print("–°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ü–µ–Ω—É...")
        return create_test_scene()

def create_test_scene():
    """
    –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ü–µ–Ω—ã, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∑–∞–¥–∞–Ω–∏—è 6
    """
    def create_cube(center=(0, 0, 0), size=2):
        cx, cy, cz = center
        half = size / 2
        vertices = np.array([
            [cx - half, cx + half, cx + half, cx - half,
             cx - half, cx + half, cx + half, cx - half],
            [cy - half, cy - half, cy + half, cy + half,
             cy - half, cy - half, cy + half, cy + half],
            [cz - half, cz - half, cz - half, cz - half,
             cz + half, cz + half, cz + half, cz + half],
            [1, 1, 1, 1, 1, 1, 1, 1]
        ], dtype=np.float64)
        faces = np.array([
            [0, 1, 2, 3], [4, 5, 6, 7], [0, 1, 5, 4],
            [2, 3, 7, 6], [1, 2, 6, 5], [0, 3, 7, 4]
        ])
        return vertices, faces

    # –°–æ–∑–¥–∞—ë–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—É–±–æ–≤ –¥–ª—è —Å—Ü–µ–Ω—ã
    cube1, faces = create_cube(center=(0, 0, 0), size=2)
    cube2, _ = create_cube(center=(3, 0, 0), size=1.5)
    cube3, _ = create_cube(center=(0, 3, 0), size=1.2)
    cube4, _ = create_cube(center=(-2, -2, 2), size=0.8)

    cubes = [
        (cube1, 'lightblue'),
        (cube2, 'lightgreen'),
        (cube3, 'lightcoral'),
        (cube4, 'lightgoldenrodyellow')
    ]

    # –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –º–∞—Ç—Ä–∏—Ü—É –∫–∞–º–µ—Ä—ã
    C = np.eye(4)
    C_inv = np.eye(4)

    return cubes, faces, C, C_inv

def draw_shape_perspective(ax, vertices, faces, color='lightblue', alpha=0.7):
    """
    –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–∏–≥—É—Ä—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
    """
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
    w = vertices[3, :]
    w_safe = np.where(np.abs(w) < 1e-8, 1e-8, w)
    cartesian_vertices = (vertices[:3, :] / w_safe).T

    # –°–æ–∑–¥–∞—ë–º –ø–æ–ª–∏–≥–æ–Ω–Ω—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é
    poly = Poly3DCollection(
        cartesian_vertices[faces],
        facecolors=color,
        edgecolors='darkblue',
        linewidths=0.6,
        alpha=alpha,
        shade=True
    )
    ax.add_collection3d(poly)
    return cartesian_vertices

def setup_3d_view(ax, elev=25, azim=-45):
    """
    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≥–ª–∞ –æ–±–∑–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
    """
    ax.view_init(elev=elev, azim=azim)

def create_perspective_matrix(fov_deg=60.0, aspect=1.0, near=0.5, far=20.0):
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã (OpenGL-—Å—Ç–∏–ª—å)

    Parameters:
    -----------
    fov_deg : float
        –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —É–≥–æ–ª –æ–±–∑–æ—Ä–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    aspect : float
        –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω (—à–∏—Ä–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞)
    near : float
        –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–Ω–µ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –æ—Ç—Å–µ—á–µ–Ω–∏—è
    far : float
        –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥–∞–ª—å–Ω–µ–π –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –æ—Ç—Å–µ—á–µ–Ω–∏—è

    Returns:
    --------
    P : np.ndarray
        –ú–∞—Ç—Ä–∏—Ü–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã 4x4
    """
    # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —É–≥–æ–ª –æ–±–∑–æ—Ä–∞ –≤ —Ä–∞–¥–∏–∞–Ω—ã
    fov_rad = np.radians(fov_deg)
    f = 1.0 / np.tan(fov_rad / 2.0)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Ç—Ä–∏—Ü—É
    P = np.zeros((4, 4), dtype=np.float64)

    # –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Ç—Ä–∏—Ü—É
    P[0, 0] = f / aspect
    P[1, 1] = f
    P[2, 2] = -(far + near) / (far - near)
    P[2, 3] = -(2.0 * far * near) / (far - near)
    P[3, 2] = -1.0

    return P

def apply_perspective(vertices, P):
    """
    –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∫ –≤–µ—Ä—à–∏–Ω–∞–º
    """
    return P @ vertices

# ============================== –¢–ï–û–†–ò–Ø –ò –†–ê–°–ß–Å–¢–´ ==============================

def print_theory_perspective():
    """
    –í—ã–≤–æ–¥ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ
    """
    print("\n" + "="*60)
    print("–¢–ï–û–†–ï–¢–ò–ß–ï–°–ö–ê–Ø –ß–ê–°–¢–¨: –ú–ê–¢–†–ò–¶–ê –ü–ï–†–°–ü–ï–ö–¢–ò–í–´")
    print("="*60)

    print("\n1. –û–±—â–∞—è —Ñ–æ—Ä–º–∞ –º–∞—Ç—Ä–∏—Ü—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã (OpenGL-—Å—Ç–∏–ª—å):")
    print("   ‚é° f/aspect   0        0             0       ‚é§")
    print("   ‚é¢   0        f        0             0       ‚é•")
    print("   ‚é¢   0        0   -(f+n)/(f-n)  -2fn/(f-n) ‚é•")
    print("   ‚é£   0        0       -1             0       ‚é¶")
    print("   –≥–¥–µ f = 1/tan(fov/2), n = near, f = far")

    print("\n2. –ì–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:")
    print("   ‚Ä¢ –ú–∞—Ç—Ä–∏—Ü–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —É—Å–µ—á—ë–Ω–Ω—ã–π –∫–æ–Ω—É—Å –≤–∏–¥–∏–º–æ—Å—Ç–∏ (frustum)")
    print("     –≤ –∫—É–± —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ [-1, 1] –ø–æ –≤—Å–µ–º –æ—Å—è–º")
    print("   ‚Ä¢ –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞—Ç—Ä–∏—Ü—ã P, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ w —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ä–∞–≤–Ω–æ–π -z")
    print("   ‚Ä¢ –ü—Ä–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –≤ –¥–µ–∫–∞—Ä—Ç–æ–≤—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ w)")
    print("     –ø–æ–ª—É—á–∞–µ–º –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: (x/z, y/z)")
    print("   ‚Ä¢ –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç —ç—Ñ—Ñ–µ–∫—Ç: –¥–∞–ª—å–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã –∫–∞–∂—É—Ç—Å—è –º–µ–Ω—å—à–µ")

    print("\n3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:")
    print("   ‚Ä¢ FOV (Field of View) - –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —É–≥–æ–ª –æ–±–∑–æ—Ä–∞")
    print("   ‚Ä¢ Aspect ratio - —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω (—à–∏—Ä–∏–Ω–∞/–≤—ã—Å–æ—Ç–∞)")
    print("   ‚Ä¢ Near/Far - –±–ª–∏–∂–Ω—è—è –∏ –¥–∞–ª—å–Ω—è—è –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –æ—Ç—Å–µ—á–µ–Ω–∏—è")
    print("   ‚Ä¢ –ë–æ–ª—å—à–æ–π FOV ‚Üí '—à–∏—Ä–æ–∫–æ—É–≥–æ–ª—å–Ω—ã–π' —ç—Ñ—Ñ–µ–∫—Ç —Å –∏—Å–∫–∞–∂–µ–Ω–∏—è–º–∏ –ø–æ –∫—Ä–∞—è–º")
    print("   ‚Ä¢ –ú–∞–ª–µ–Ω—å–∫–∏–π FOV ‚Üí '—Ç–µ–ª–µ–æ–±—ä–µ–∫—Ç–∏–≤', —Å–∂–∞—Ç–∞—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞")

    print("\n4. –ê–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞:")
    print("   ‚Ä¢ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ - –ø—Ä–æ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –∞ –Ω–µ –∞—Ñ—Ñ–∏–Ω–Ω–æ–µ")
    print("   ‚Ä¢ –ù–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å –ª–∏–Ω–∏–π")
    print("   ‚Ä¢ –¢–æ—á–∫–∏ –Ω–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏")
    print("   ‚Ä¢ –Ø–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç–Ω—ã–º —Å–ª—É—á–∞–µ–º –ø—Ä–æ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è")

# ============================== –ó–ê–î–ê–ù–ò–ï 7 ==============================

def task7():
    """
    –ó–∞–¥–∞–Ω–∏–µ 7: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
    """
    print("="*60)
    print("–ó–ê–î–ê–ù–ò–ï 7: –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–°–ü–ï–ö–¢–ò–í–´")
    print("="*60)

    # –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ü–µ–Ω—ã –∏–∑ –∑–∞–¥–∞–Ω–∏—è 6
    print("\nüì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ü–µ–Ω—ã –∏–∑ –∑–∞–¥–∞–Ω–∏—è 6...")
    cubes, faces, C, C_inv = load_task6_data()
    print(f"   –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(cubes)} –∫—É–±–∏–∫–æ–≤")

    # –í—ã–≤–æ–¥ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    print_theory_perspective()

    # ==================== –ß–ê–°–¢–¨ 1: –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–†–°–ü–ï–ö–¢–ò–í–´ ====================
    print("\n" + "="*60)
    print("–ß–ê–°–¢–¨ 1: –ü–ê–†–ê–ú–ï–¢–†–´ –ü–ï–†–°–ü–ï–ö–¢–ò–í–´ –ò –°–û–ó–î–ê–ù–ò–ï –ú–ê–¢–†–ò–¶–´")
    print("="*60)

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
    fov = 60.0    # –£–≥–æ–ª –æ–±–∑–æ—Ä–∞ –≤ –≥—Ä–∞–¥—É—Å–∞—Ö
    aspect = 1.0  # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω
    near = 0.5    # –ë–ª–∏–∂–Ω—è—è –ø–ª–æ—Å–∫–æ—Å—Ç—å
    far = 20.0    # –î–∞–ª—å–Ω—è—è –ø–ª–æ—Å–∫–æ—Å—Ç—å

    print(f"\n1. –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:")
    print(f"   ‚Ä¢ FOV: {fov}¬∞")
    print(f"   ‚Ä¢ Aspect ratio: {aspect}")
    print(f"   ‚Ä¢ Near plane: {near}")
    print(f"   ‚Ä¢ Far plane: {far}")

    # –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
    P = create_perspective_matrix(fov_deg=fov, aspect=aspect, near=near, far=far)
    print(f"\n2. –ú–∞—Ç—Ä–∏—Ü–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã P:")
    print(P)

    # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∫–æ –≤—Å–µ–º –∫—É–±–∏–∫–∞–º
    print("\n3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞—Ç—Ä–∏—Ü—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –∫–æ –≤—Å–µ–º –æ–±—ä–µ–∫—Ç–∞–º —Å—Ü–µ–Ω—ã:")
    perspective_cubes = []
    for i, (vertices, color) in enumerate(cubes):
        persp_vertices = apply_perspective(vertices, P)
        perspective_cubes.append((persp_vertices, color))
        print(f"   ‚Ä¢ –ö—É–±–∏–∫ {i+1}: –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞")

    # ==================== –ß–ê–°–¢–¨ 2: –°–†–ê–í–ù–ï–ù–ò–ï –ü–†–û–ï–ö–¶–ò–ô ====================
    print("\n" + "="*60)
    print("–ß–ê–°–¢–¨ 2: –°–†–ê–í–ù–ï–ù–ò–ï –û–†–¢–û–ì–û–ù–ê–õ–¨–ù–û–ô –ò –ü–ï–†–°–ü–ï–ö–¢–ò–í–ù–û–ô –ü–†–û–ï–ö–¶–ò–ô")
    print("="*60)

    print("\n4. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ü–∏–π:")

    # –°–æ–∑–¥–∞—ë–º —Ñ–∏–≥—É—Ä—É —Å –¥–≤—É–º—è –ø–æ–¥–≥—Ä–∞—Ñ–∏–∫–∞–º–∏
    fig, axes = plt.subplots(1, 2, figsize=(15, 7), subplot_kw={'projection': '3d'})

    # –û—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞)
    ax = axes[0]
    ax.set_box_aspect([1, 1, 1])
    ax.set_xlim(-4, 6)
    ax.set_ylim(-4, 6)
    ax.set_zlim(-3, 5)
    ax.grid(True)
    setup_3d_view(ax, elev=25, azim=-45)
    ax.set_xlabel('X')
    ax.set_ylabel('Y')
    ax.set_zlabel('Z')

    for vertices, color in cubes:
        draw_shape_perspective(ax, vertices, faces, color, alpha=0.7)

    ax.set_title("–û—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è\n(–±–µ–∑ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã)", fontsize=12, pad=15)

    # –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è
    ax = axes[1]
    ax.set_box_aspect([1, 1, 1])
    ax.set_xlim(-2, 4)
    ax.set_ylim(-2, 4)
    ax.set_zlim(-2, 2)
    ax.grid(True)
    setup_3d_view(ax, elev=25, azim=-45)
    ax.set_xlabel('X')
    ax.set_ylabel('Y')
    ax.set_zlabel('Z')

    for vertices, color in perspective_cubes:
        draw_shape_perspective(ax, vertices, faces, color, alpha=0.7)

    ax.set_title("–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è\n(FOV=60¬∞)", fontsize=12, pad=15)

    plt.tight_layout()
    plt.savefig('img/task7_orthographic_vs_perspective.png', dpi=150, bbox_inches='tight', pad_inches=0.1)
    print("   –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: img/task7_orthographic_vs_perspective.png")
    plt.show()

    # ==================== –ß–ê–°–¢–¨ 3: –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ï–§–û–†–ú–ê–¶–ò–ò –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê ====================
    print("\n" + "="*60)
    print("–ß–ê–°–¢–¨ 3: –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –î–ï–§–û–†–ú–ê–¶–ò–ò –ü–†–û–°–¢–†–ê–ù–°–¢–í–ê –ü–†–ò –í–†–ê–©–ï–ù–ò–ò")
    print("="*60)

    print("\n5. –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —É–≥–ª–∞—Ö –æ–±–∑–æ—Ä–∞:")

    # –ó–∞–¥–∞—ë–º —Ä–∞–∑–Ω—ã–µ —É–≥–ª—ã –æ–±–∑–æ—Ä–∞
    views = [
        (25, -45),   # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–∏–¥
        (25, 45),    # –í–∏–¥ —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
        (60, -45),   # –í–∏–¥ —Å–≤–µ—Ä—Ö—É
        (-20, -45)   # –í–∏–¥ —Å–Ω–∏–∑—É
    ]

    # –°–æ–∑–¥–∞—ë–º —Ñ–∏–≥—É—Ä—É 2x2
    fig, axes = plt.subplots(2, 2, figsize=(14, 12), subplot_kw={'projection': '3d'})
    fig.suptitle("–≠—Ñ—Ñ–µ–∫—Ç—ã –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —É–≥–ª–∞—Ö –æ–±–∑–æ—Ä–∞\n(FOV=60¬∞)", fontsize=16, y=0.98)

    for idx, (elev, azim) in enumerate(views):
        row = idx // 2
        col = idx % 2
        ax = axes[row, col]

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Å–µ–π
        ax.set_box_aspect([1, 1, 1])
        ax.set_xlim(-2, 4)
        ax.set_ylim(-2, 4)
        ax.set_zlim(-2, 2)
        ax.grid(True)
        setup_3d_view(ax, elev=elev, azim=azim)
        ax.set_xlabel('X')
        ax.set_ylabel('Y')
        ax.set_zlabel('Z')

        # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫—É–±–∏–∫–æ–≤
        for vertices, color in perspective_cubes:
            draw_shape_perspective(ax, vertices, faces, color, alpha=0.7)

        ax.set_title(f"elev={elev}¬∞, azim={azim}¬∞", fontsize=12, pad=10)

    plt.tight_layout(rect=[0, 0, 1, 0.96])
    plt.savefig('img/task7_perspective_rotations.png', dpi=150, bbox_inches='tight', pad_inches=0.1)
    print("   –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: img/task7_perspective_rotations.png")
    plt.show()

    # ==================== –ß–ê–°–¢–¨ 4: –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ====================
    print("\n" + "="*60)
    print("–ß–ê–°–¢–¨ 4: –ê–ù–ê–õ–ò–ó –†–ï–ó–£–õ–¨–¢–ê–¢–û–í")
    print("="*60)

    print("\n6. –ê–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:")

    # 4.1 –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã
    print("\n   –∞) –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:")
    print("   ‚Ä¢ –ö—É–±–∏–∫–∏, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã–µ –¥–∞–ª—å—à–µ –æ—Ç –∫–∞–º–µ—Ä—ã, –≤—ã–≥–ª—è–¥—è—Ç –º–µ–Ω—å—à–µ")
    print("   ‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ä—ë–±—Ä–∞, —É—Ö–æ–¥—è—â–∏–µ –≤–≥–ª—É–±—å —Å—Ü–µ–Ω—ã, —Å—Ö–æ–¥—è—Ç—Å—è")
    print("   ‚Ä¢ –°–æ–∑–¥–∞—ë—Ç—Å—è –∏–ª–ª—é–∑–∏—è –≥–ª—É–±–∏–Ω—ã –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞")

    # 4.2 –ê–Ω–∞–ª–∏–∑ –≤–ª–∏—è–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    print("\n   –±) –í–ª–∏—è–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã:")
    print("   ‚Ä¢ FOV=60¬∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –≥–ª—É–±–∏–Ω—ã")
    print("   ‚Ä¢ Near=0.5 –∏—Å–∫–ª—é—á–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã –æ—Ç –∏—Å–∫–∞–∂–µ–Ω–∏–π")
    print("   ‚Ä¢ Far=20.0 –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å —Å—Ü–µ–Ω—ã")

    # 4.3 –ê–Ω–∞–ª–∏–∑ –¥–µ—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏
    print("\n   –≤) –î–µ—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏:")
    print("   ‚Ä¢ –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —É–≥–ª–∞ –æ–±–∑–æ—Ä–∞ (elev=60¬∞) —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã")
    print("   ‚Ä¢ –ü—Ä–∏ –≤–∏–¥–µ —Å–Ω–∏–∑—É (elev=-20¬∞) –∫—É–±–∏–∫–∏, –±–ª–∏–∑–∫–∏–µ –∫ –∫–∞–º–µ—Ä–µ, —Å–∏–ª—å–Ω–æ –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç")
    print("   ‚Ä¢ –ü—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏ –ø–æ –∞–∑–∏–º—É—Ç—É (azim=45¬∞) –º–µ–Ω—è–µ—Ç—Å—è –≤–∏–¥–∏–º–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–æ–≤")

    # 4.4 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–µ–π
    print("\n   –≥) –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–µ–π:")
    print("   ‚Ä¢ –í –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–∏ –≤—Å–µ –∫—É–±–∏–∫–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä")
    print("   ‚Ä¢ –í –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –∫–∞–º–µ—Ä—ã")
    print("   ‚Ä¢ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ —Å–æ–∑–¥–∞—ë—Ç –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –≥–ª—É–±–∏–Ω—ã")

    # ==================== –ß–ê–°–¢–¨ 5: –í–´–í–û–î–´ ====================
    print("\n" + "="*60)
    print("–ß–ê–°–¢–¨ 5: –í–´–í–û–î–´")
    print("="*60)

    print("\n1. –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã:")
    print("   ‚Ä¢ –ú–∞—Ç—Ä–∏—Ü–∞ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ")
    print("   ‚Ä¢ –ö–ª—é—á–µ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º - –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É w (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ –¥–µ–ª–µ–Ω–∏—é –Ω–∞ z)")
    print("   ‚Ä¢ –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (FOV, aspect, near, far)")

    print("\n2. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:")
    print("   ‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω")
    print("   ‚Ä¢ –î–∞–ª—å–Ω–∏–µ –æ–±—ä–µ–∫—Ç—ã –≤—ã–≥–ª—è–¥—è—Ç –º–µ–Ω—å—à–µ, —á—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –æ—â—É—â–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã")
    print("   ‚Ä¢ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å—Ö–æ–¥—è—Ç—Å—è, –∏–º–∏—Ç–∏—Ä—É—è —Ä–µ–∞–ª—å–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ")
    print("   ‚Ä¢ –≠—Ñ—Ñ–µ–∫—Ç —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ FOV –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É–≥–ª–∞ –æ–±–∑–æ—Ä–∞")

    print("\n3. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ü–∏–π:")
    print("   ‚Ä¢ –û—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å")
    print("   ‚Ä¢ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –∏—Å–∫–∞–∂–∞–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª—É–±–∏–Ω—ã")
    print("   ‚Ä¢ –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø—Ä–æ–µ–∫—Ü–∏–∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–∞–¥–∞—á–∏ (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —á–µ—Ä—Ç–µ–∂–∏ vs —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)")

    print("\n4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:")
    print("   ‚Ä¢ –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ - –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ 3D-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ")
    print("   ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–≥—Ä–∞—Ö –∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö")
    print("   ‚Ä¢ –Ø–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–æ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π")

    print("\n" + "="*60)
    print("–ó–ê–î–ê–ù–ò–ï 7 –í–´–ü–û–õ–ù–ï–ù–û")
    print("="*60)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞–Ω–∏–π
    np.savez('data/task7_data.npz',
            cubes_vertices=[c[0] for c in cubes],
            persp_cubes_vertices=[c[0] for c in perspective_cubes],
            cubes_colors=[c[1] for c in cubes],
            faces=faces,
            P=P)
    print("\n–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/task7_data.npz")

    return perspective_cubes, P

# ============================== –ó–ê–ü–£–°–ö ==============================

if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞–Ω–∏–µ 7
    perspective_cubes, P = task7()